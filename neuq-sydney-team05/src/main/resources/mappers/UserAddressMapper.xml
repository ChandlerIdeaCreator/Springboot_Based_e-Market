<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.school_mall.repository.UserAddressMapper">
  
  <resultMap id="BaseResultMap" type="com.school_mall.entity.UserAddress">
    <id column="id" property="id" jdbcType="BIGINT"/>
    <result column="user_id" property="userId" jdbcType="BIGINT"/>
    <result column="receiver" property="receiver" jdbcType="VARCHAR"/>
    <result column="phone" property="phone" jdbcType="VARCHAR"/>
    <result column="region" property="region" jdbcType="VARCHAR"/>
    <result column="detail_address" property="detailAddress" jdbcType="VARCHAR"/>
    <result column="is_default" property="isDefault" jdbcType="TINYINT"/>
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP"/>
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP"/>
  </resultMap>
  
  <sql id="Base_Column_List">
    id, user_id, receiver, phone, region, detail_address, is_default, create_time, update_time
  </sql>
  
  <select id="selectById" parameterType="long" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM user_address
    WHERE id = #{id}
  </select>

  <select id="selectAll" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM user_address
  </select>

  <select id="selectByUserId" parameterType="long" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM user_address
    WHERE user_id = #{userId}
    ORDER BY is_default DESC, create_time DESC
  </select>

  <select id="selectDefaultByUserId" parameterType="long" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM user_address
    WHERE user_id = #{userId} AND is_default = 1
    LIMIT 1
  </select>

  <select id="selectByRegion" parameterType="string" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM user_address
    WHERE region LIKE CONCAT('%', #{region}, '%')
  </select>

  <select id="selectByUserIdAndRegion" parameterType="map" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM user_address
    WHERE user_id = #{userId} AND region LIKE CONCAT('%', #{region}, '%')
  </select>

  <select id="selectByPhone" parameterType="string" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List"/>
    FROM user_address
    WHERE phone = #{phone}
  </select>

  <select id="countByUserId" parameterType="long" resultType="int">
    SELECT COUNT(*)
    FROM user_address
    WHERE user_id = #{userId}
  </select>

  <select id="hasDefaultAddress" parameterType="long" resultType="boolean">
    SELECT COUNT(*) > 0
    FROM user_address
    WHERE user_id = #{userId} AND is_default = 1
  </select>

  <insert id="insert" parameterType="com.school_mall.entity.UserAddress" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO user_address (user_id, receiver, phone, region, detail_address, is_default, create_time, update_time)
    VALUES (#{userId}, #{receiver}, #{phone}, #{region}, #{detailAddress}, #{isDefault}, #{createTime}, #{updateTime})
  </insert>

  <insert id="insertSelective" parameterType="com.school_mall.entity.UserAddress" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO user_address
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="userId != null">user_id,</if>
      <if test="receiver != null">receiver,</if>
      <if test="phone != null">phone,</if>
      <if test="region != null">region,</if>
      <if test="detailAddress != null">detail_address,</if>
      <if test="isDefault != null">is_default,</if>
      <if test="createTime != null">create_time,</if>
      <if test="updateTime != null">update_time,</if>
    </trim>
    <trim prefix="VALUES (" suffix=")" suffixOverrides=",">
      <if test="userId != null">#{userId},</if>
      <if test="receiver != null">#{receiver},</if>
      <if test="phone != null">#{phone},</if>
      <if test="region != null">#{region},</if>
      <if test="detailAddress != null">#{detailAddress},</if>
      <if test="isDefault != null">#{isDefault},</if>
      <if test="createTime != null">#{createTime},</if>
      <if test="updateTime != null">#{updateTime},</if>
    </trim>
  </insert>

  <update id="updateById" parameterType="com.school_mall.entity.UserAddress">
    UPDATE user_address
    SET user_id = #{userId}, receiver = #{receiver}, phone = #{phone},
        region = #{region}, detail_address = #{detailAddress}, 
        is_default = #{isDefault}, create_time = #{createTime}, 
        update_time = #{updateTime}
    WHERE id = #{id}
  </update>

  <update id="updateByIdSelective" parameterType="com.school_mall.entity.UserAddress">
    UPDATE user_address
    <set>
      <if test="userId != null">user_id = #{userId},</if>
      <if test="receiver != null">receiver = #{receiver},</if>
      <if test="phone != null">phone = #{phone},</if>
      <if test="region != null">region = #{region},</if>
      <if test="detailAddress != null">detail_address = #{detailAddress},</if>
      <if test="isDefault != null">is_default = #{isDefault},</if>
      <if test="createTime != null">create_time = #{createTime},</if>
      <if test="updateTime != null">update_time = #{updateTime},</if>
    </set>
    WHERE id = #{id}
  </update>

  <update id="clearDefaultByUserId" parameterType="long">
    UPDATE user_address
    SET is_default = 0, update_time = NOW()
    WHERE user_id = #{userId} AND is_default = 1
  </update>

  <update id="setAsDefault" parameterType="map">
    UPDATE user_address
    SET is_default = 1, update_time = NOW()
    WHERE id = #{addressId} AND user_id = #{userId}
  </update>

  <delete id="deleteById" parameterType="long">
    DELETE FROM user_address WHERE id = #{id}
  </delete>

  <delete id="deleteByUserId" parameterType="long">
    DELETE FROM user_address WHERE user_id = #{userId}
  </delete>

  <delete id="deleteNonDefaultByUserId" parameterType="long">
    DELETE FROM user_address 
    WHERE user_id = #{userId} AND is_default = 0
  </delete>

</mapper>
